name: ğŸ§¼ Pull request closed
on:
  pull_request:
    types:
      - closed
      - unlabeled

env:
  ACTIONS_STEP_DEBUG: true

jobs:
  log:
    name: ğŸªµ Log some helpful vars
    runs-on: ubuntu-latest
    steps:
      # Slashes in the ref_name will break Fly's Docker tags.
      - name: Replace slashes in ref_name
        id: replace_slashes_in_ref_name
        uses: frabert/replace-string-action@v2.4
        with:
          pattern: '(\d+)/merge'
          string: "${{ github.ref_name }}"
          replace-with: "$1-merge"
          flags: "g"

      - run: |
          echo "::group::Log some helpful vars"
          echo "ğŸ· ref = ${{ github.ref }}"
          echo "ğŸ· ref_name = ${{ github.ref_name }}"
          echo "ğŸ· clean ref_name = ${{ steps.replace_slashes_in_ref_name.outputs.replaced }}"
          echo "ğŸ· event_name = ${{ github.event_name }}"
          echo "ğŸ· action = ${{ github.event.action }}"
          echo "ğŸ· event.number = ${{ github.event.number }}"
          echo "ğŸ· contains \"staging\" label = ${{ contains(github.event.pull_request.labels.*.name, 'staging') }}"
          echo "ğŸ· environment = remixaustin-com-pr-${{ github.event.number }}"
          echo "::endgroup:: "

  cleanup:
    name: ğŸ§¼ Clean up GitHub environment after closing PR
    runs-on: ubuntu-latest
    needs: [log]
    permissions: write-all
    if: |
      (github.event.action == 'unlabeled' && github.event.label.name == 'staging')
      || (github.event.action == 'closed' && contains(github.event.pull_request.labels.*.name, 'staging'))

    # Only run one deployment at a time per PR.
    concurrency:
      group: ${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: ğŸ§¼ Clean up GitHub environment after closing PR
        uses: strumwolf/delete-deployment-environment@v2.2.3
        if: |
          (github.event.action == 'unlabeled' && github.event.label.name == 'staging')
          || (github.event.action == 'closed' && contains(github.event.pull_request.labels.*.name, 'staging'))
        with:
          # The provided token needs permission for admin write:org
          token: ${{ secrets.GH_APP_INSTALLATION_TOKEN }}
          environment: remixaustin-com-pr-${{ github.event.number }}
          ref: ${{ github.ref_name }}

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ğŸ§¼ Delete Fly deployment
        run: "flyctl apps destroy remixaustin-com-pr-${{ github.event.number }} -y"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ’¬ Comment URL on PR
        uses: unsplash/comment-on-pr@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: |
            #### ğŸ§¼ Cleaned up the deployment

            ~~https://remixaustin-com-pr-${{ github.event.number }}.fly.dev~~
          check_for_duplicate_msg: true
